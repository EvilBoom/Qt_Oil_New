# nuitka-project: --follow-imports
# nuitka-project: --enable-plugin=pyside6
# nuitka-project: --output-dir=D:\projects\Oil\Qt_Oil_New\deployment
# nuitka-project: --quiet
# nuitka-project: --noinclude-qt-translations
# nuitka-project: --output-dir=deployment
# nuitka-project: --output-filename=Recommendation
# nuitka-project: --standalone
# nuitka-project: --include-data-dir=D:\projects\Oil\Qt_Oil_New\.vs=./.vs
# nuitka-project: --include-data-dir=D:\projects\Oil\Qt_Oil_New\App=./App
# nuitka-project: --include-data-dir=D:\projects\Oil\Qt_Oil_New\backups=./backups
# nuitka-project: --include-data-dir=D:\projects\Oil\Qt_Oil_New\cmake=./cmake
# nuitka-project: --include-data-dir=D:\projects\Oil\Qt_Oil_New\Controller=./Controller
# nuitka-project: --include-data-dir=D:\projects\Oil\Qt_Oil_New\data=./data
# nuitka-project: --include-data-dir=D:\projects\Oil\Qt_Oil_New\DataManage=./DataManage
# nuitka-project: --include-data-dir=D:\projects\Oil\Qt_Oil_New\Dependencies=./Dependencies
# nuitka-project: --include-data-dir=D:\projects\Oil\Qt_Oil_New\dev=./dev
# nuitka-project: --include-data-dir=D:\projects\Oil\Qt_Oil_New\drafts=./drafts
# nuitka-project: --include-data-dir=D:\projects\Oil\Qt_Oil_New\Generated=./Generated
# nuitka-project: --include-data-dir=D:\projects\Oil\Qt_Oil_New\GLRsave=./GLRsave
# nuitka-project: --include-data-dir=D:\projects\Oil\Qt_Oil_New\models=./models
# nuitka-project: --include-data-dir=D:\projects\Oil\Qt_Oil_New\out=./out
# nuitka-project: --include-data-dir=D:\projects\Oil\Qt_Oil_New\production=./production
# nuitka-project: --include-data-dir=D:\projects\Oil\Qt_Oil_New\QFsave=./QFsave
# nuitka-project: --include-data-dir=D:\projects\Oil\Qt_Oil_New\qml Qt_Oil_NewContent=./qml Qt_Oil_NewContent
# nuitka-project: --include-data-dir=D:\projects\Oil\Qt_Oil_New\Qt_Oil_New=./Qt_Oil_New
# nuitka-project: --include-data-dir=D:\projects\Oil\Qt_Oil_New\Qt_Oil_NewContent=./Qt_Oil_NewContent
# nuitka-project: --include-data-dir=D:\projects\Oil\Qt_Oil_New\TDHsave=./TDHsave
# nuitka-project: --noinclude-dlls=*.cpp.o
# nuitka-project: --noinclude-dlls=*.qsb
# nuitka-project: --include-data-files=D:\projects\Oil\Qt_Oil_New\Qt_Oil_NewContent\OilWellManagement\OilWellManagementPage.qml=./Qt_Oil_NewContent\OilWellManagement\OilWellManagementPage.qml
# nuitka-project: --include-data-files=D:\projects\Oil\Qt_Oil_New\Qt_Oil_NewContent\OilWellManagement\WellDataDialog.qml=./Qt_Oil_NewContent\OilWellManagement\WellDataDialog.qml
# nuitka-project: --include-data-files=D:\projects\Oil\Qt_Oil_New\Qt_Oil_NewContent\OilWellManagement\components\WellDataDialogForm.ui.qml=./Qt_Oil_NewContent\OilWellManagement\components\WellDataDialogForm.ui.qml
# nuitka-project: --include-data-files=D:\projects\Oil\Qt_Oil_New\Qt_Oil_NewContent\WellStructure\WellSchematicView.qml=./Qt_Oil_NewContent\WellStructure\WellSchematicView.qml
# nuitka-project: --include-data-files=D:\projects\Oil\Qt_Oil_New\Qt_Oil_NewContent\WellStructure\WellStructurePage.qml=./Qt_Oil_NewContent\WellStructure\WellStructurePage.qml
# nuitka-project: --include-data-files=D:\projects\Oil\Qt_Oil_New\Qt_Oil_NewContent\WellStructure\components\CasingListItem.qml=./Qt_Oil_NewContent\WellStructure\components\CasingListItem.qml
# nuitka-project: --include-data-files=D:\projects\Oil\Qt_Oil_New\Qt_Oil_NewContent\WellStructure\components\CasingEditDialog.qml=./Qt_Oil_NewContent\WellStructure\components\CasingEditDialog.qml
# nuitka-project: --include-data-files=D:\projects\Oil\Qt_Oil_New\Qt_Oil_NewContent\WellStructure\components\ExcelImportDialog.qml=./Qt_Oil_NewContent\WellStructure\components\ExcelImportDialog.qml
# nuitka-project: --include-data-files=D:\projects\Oil\Qt_Oil_New\Qt_Oil_NewContent\WellStructure\components\WellTrajectoryDataView.qml=./Qt_Oil_NewContent\WellStructure\components\WellTrajectoryDataView.qml
# nuitka-project: --include-data-files=D:\projects\Oil\Qt_Oil_New\main.qml=./main.qml
# nuitka-project: --include-data-files=D:\projects\Oil\Qt_Oil_New\Qt_Oil_NewContent\WellStructure\components\CalculationResultDialog.qml=./Qt_Oil_NewContent\WellStructure\components\CalculationResultDialog.qml
# nuitka-project: --include-data-files=D:\projects\Oil\Qt_Oil_New\Qt_Oil_NewContent\WellStructure\components\CasingListView.qml=./Qt_Oil_NewContent\WellStructure\components\CasingListView.qml
# nuitka-project: --include-data-files=D:\projects\Oil\Qt_Oil_New\Qt_Oil_NewContent\WellStructure\components\WellTrajectoryChart.qml=./Qt_Oil_NewContent\WellStructure\components\WellTrajectoryChart.qml
# nuitka-project: --include-data-files=D:\projects\Oil\Qt_Oil_New\Qt_Oil_NewContent\DeviceManagement\DeviceManagementPage.qml=./Qt_Oil_NewContent\DeviceManagement\DeviceManagementPage.qml
# nuitka-project: --include-data-files=D:\projects\Oil\Qt_Oil_New\Qt_Oil_NewContent\DeviceManagement\components\DeviceListView.qml=./Qt_Oil_NewContent\DeviceManagement\components\DeviceListView.qml
# nuitka-project: --include-data-files=D:\projects\Oil\Qt_Oil_New\Qt_Oil_NewContent\DeviceManagement\components\DeviceDetailPanel.qml=./Qt_Oil_NewContent\DeviceManagement\components\DeviceDetailPanel.qml
# nuitka-project: --include-data-files=D:\projects\Oil\Qt_Oil_New\Qt_Oil_NewContent\DeviceManagement\components\DeviceFilterBar.qml=./Qt_Oil_NewContent\DeviceManagement\components\DeviceFilterBar.qml
# nuitka-project: --include-data-files=D:\projects\Oil\Qt_Oil_New\Qt_Oil_NewContent\DeviceManagement\components\DeviceCard.qml=./Qt_Oil_NewContent\DeviceManagement\components\DeviceCard.qml
# nuitka-project: --include-data-files=D:\projects\Oil\Qt_Oil_New\Qt_Oil_NewContent\DeviceManagement\components\AddEditDeviceDialog.qml=./Qt_Oil_NewContent\DeviceManagement\components\AddEditDeviceDialog.qml
# nuitka-project: --include-data-files=D:\projects\Oil\Qt_Oil_New\Qt_Oil_NewContent\DeviceManagement\components\DeviceImportDialog.qml=./Qt_Oil_NewContent\DeviceManagement\components\DeviceImportDialog.qml
# nuitka-project: --include-data-files=D:\projects\Oil\Qt_Oil_New\Qt_Oil_NewContent\DeviceManagement\components\DeviceExportDialog.qml=./Qt_Oil_NewContent\DeviceManagement\components\DeviceExportDialog.qml
# nuitka-project: --include-data-files=D:\projects\Oil\Qt_Oil_New\Qt_Oil_NewContent\DeviceManagement\components\Toast.qml=./Qt_Oil_NewContent\DeviceManagement\components\Toast.qml
# nuitka-project: --include-data-files=D:\projects\Oil\Qt_Oil_New\Qt_Oil_NewContent\DeviceRecommendation\DeviceRecommendationPage.qml=./Qt_Oil_NewContent\DeviceRecommendation\DeviceRecommendationPage.qml
# nuitka-project: --include-data-files=D:\projects\Oil\Qt_Oil_New\Qt_Oil_NewContent\DeviceRecommendation\Steps\Step1_ProductionParameters.qml=./Qt_Oil_NewContent\DeviceRecommendation\Steps\Step1_ProductionParameters.qml
# nuitka-project: --include-data-files=D:\projects\Oil\Qt_Oil_New\Qt_Oil_NewContent\DeviceRecommendation\Steps\Step2_PredictionResults.qml=./Qt_Oil_NewContent\DeviceRecommendation\Steps\Step2_PredictionResults.qml
# nuitka-project: --include-data-files=D:\projects\Oil\Qt_Oil_New\Qt_Oil_NewContent\DeviceRecommendation\Steps\Step3_LiftMethodSelection.qml=./Qt_Oil_NewContent\DeviceRecommendation\Steps\Step3_LiftMethodSelection.qml
# nuitka-project: --include-data-files=D:\projects\Oil\Qt_Oil_New\Qt_Oil_NewContent\DeviceRecommendation\Steps\Step4_PumpSelection.qml=./Qt_Oil_NewContent\DeviceRecommendation\Steps\Step4_PumpSelection.qml
# nuitka-project: --include-data-files=D:\projects\Oil\Qt_Oil_New\Qt_Oil_NewContent\DeviceRecommendation\Steps\Step8_ReportGeneration.qml=./Qt_Oil_NewContent\DeviceRecommendation\Steps\Step8_ReportGeneration.qml
# nuitka-project: --include-data-files=D:\projects\Oil\Qt_Oil_New\Qt_Oil_NewContent\DeviceRecommendation\Components\EnhancedPumpCurvesChart.qml=./Qt_Oil_NewContent\DeviceRecommendation\Components\EnhancedPumpCurvesChart.qml
# nuitka-project: --include-data-files=D:\projects\Oil\Qt_Oil_New\Qt_Oil_NewContent\DeviceRecommendation\Components\KnowledgeGraphWindow.qml=./Qt_Oil_NewContent\DeviceRecommendation\Components\KnowledgeGraphWindow.qml
# nuitka-project: --include-data-files=D:\projects\Oil\Qt_Oil_New\Qt_Oil_NewContent\DeviceRecommendation\Components\KnowledgeRecommendationPanel.qml=./Qt_Oil_NewContent\DeviceRecommendation\Components\KnowledgeRecommendationPanel.qml
# nuitka-project: --include-data-files=D:\projects\Oil\Qt_Oil_New\Qt_Oil_NewContent\DeviceRecommendation\Components\KnowledgeGraphCanvas.qml=./Qt_Oil_NewContent\DeviceRecommendation\Components\KnowledgeGraphCanvas.qml
# nuitka-project: --noinclude-dlls=Qt6Quick3D*
# nuitka-project: --noinclude-dlls=Qt6Sensors*
# nuitka-project: --noinclude-dlls=Qt6Test*
# nuitka-project: --noinclude-dlls=*/qml/QtQuickEffectMaker/*
# nuitka-project: --windows-icon-from-ico=D:\projects\Oil\Qt_Oil\Ot_Oil_env\Lib\site-packages\PySide6\scripts\deploy_lib\pyside_icon.ico
# nuitka-project: --include-qt-plugins=networkinformation,platforminputcontexts,qml,qmllint,qmltooling
# This Python file uses the following encoding: utf-8
import sys
from pathlib import Path
from PySide6.QtGui import QGuiApplication
from PySide6.QtWidgets import QApplication
from PySide6.QtQml import QQmlApplicationEngine
from PySide6.QtCore import QObject, Signal, Slot, QUrl

# å¯¼å…¥æ§åˆ¶å™¨
from Controller.LoginController import LoginController
from Controller.ProjectController import ProjectController
from Controller.UnitSystemController import UnitSystemController
from Controller.WellDataController import WellDataController
from Controller.ReservoirDataController import ReservoirDataController

# åœ¨main.pyçš„å¯¼å…¥éƒ¨åˆ†æ·»åŠ ï¼š
from Controller.WellStructureController import WellStructureController
from Controller.ExcelImportController import ExcelImportController
from Controller.PumpCurvesController import PumpCurvesController
from Controller.ContinuousLearningController import ContinuousLearningController
from Controller.KnowledgeGraphController import KnowledgeGraphController

# å¯¼å…¥æ•°æ®åº“æœåŠ¡
from DataManage.services.database_service import DatabaseService

from Controller.DeviceController import DeviceController                                                            
from Controller.DeviceRecommendationController import DeviceRecommendationController

import os
from PySide6.QtQuick import QQuickWindow, QSGRendererInterface
from PySide6.QtGui import QSurfaceFormat, QFont
from PySide6.QtWebEngineQuick import QtWebEngineQuick  # æ–°å¢
# os.environ["QT_QUICK_BACKEND"] = "software"  # ä½¿ç”¨è½¯ä»¶æ¸²æŸ“é¿å…GPUé—®é¢˜
# åœ¨åˆ›å»ºQApplicationä¹‹å‰è®¾ç½®
QQuickWindow.setGraphicsApi(QSGRendererInterface.OpenGL)

# è®¾ç½®OpenGLæ ¼å¼
format = QSurfaceFormat()
format.setDepthBufferSize(24)
format.setStencilBufferSize(8)
format.setVersion(3, 2)
format.setProfile(QSurfaceFormat.CoreProfile)
QSurfaceFormat.setDefaultFormat(format)

# ç¦ç”¨å›¾å½¢APIè‡ªåŠ¨æ£€æµ‹
import os
os.environ['QSG_RHI_BACKEND'] = 'opengl'



# ä¸»åº”ç”¨ç±» - ç®¡ç†åº”ç”¨ç¨‹åºç”Ÿå‘½å‘¨æœŸ
class Application(QObject):
    def __init__(self):
        super().__init__()

        # è®¾ç½®Qtå›¾å½¢ç›¸å…³ç¯å¢ƒå˜é‡
        # os.environ["QT_OPENGL"] = "software"
        # os.environ["QT_QUICK_BACKEND"] = "software"
        QtWebEngineQuick.initialize()  # æ–°å¢ï¼šåœ¨åŠ è½½ QML å‰åˆå§‹åŒ–
        self.app = QApplication(sys.argv)
        self.engine = QQmlApplicationEngine()
        # è®¾ç½®å…¨å±€å­—ä½“
        # self.setup_global_font()
        # è®¾ç½®åº”ç”¨ç¨‹åºä¿¡æ¯
        self.app.setOrganizationName("OilTech")
        self.app.setOrganizationDomain("oiltech.com")
        self.app.setApplicationName("æ²¹äº•è®¾å¤‡æ™ºèƒ½ç®¡ç†ç³»ç»Ÿ")

        # åˆå§‹åŒ–æ•°æ®åº“æœåŠ¡
        self.db_service = DatabaseService()

        # åˆå§‹åŒ–æ§åˆ¶å™¨
        self.login_controller = LoginController()
        self.project_controller = ProjectController()
        self.well_controller = WellDataController()
        self.reservoir_controller = ReservoirDataController()
        # åœ¨Applicationç±»çš„__init__æ–¹æ³•ä¸­ï¼Œåˆå§‹åŒ–æ§åˆ¶å™¨éƒ¨åˆ†æ·»åŠ ï¼š
        self.well_structure_controller = WellStructureController()
        self.excel_import_controller = ExcelImportController()
        self.device_controller = DeviceController()
        self.device_recommendation_controller = DeviceRecommendationController()
        self.pump_curves_controller = PumpCurvesController()
        self.pump_curves_controller.set_database_service(self.db_service)
        self.continuous_learning_controller = ContinuousLearningController()

        self.unit_system_controller = UnitSystemController()
        self.knowledge_graph_controller = KnowledgeGraphController()


        # å­˜å‚¨ç”¨æˆ·ä¿¡æ¯
        self.current_user = ""
        self.current_project = ""
        self.current_project_id = -1

        # è¿æ¥ç™»å½•ä¿¡å·
        self.login_controller.loginSuccess.connect(self.on_login_success)
        self.login_controller.loginFailed.connect(self.on_login_failed)

        # è¿æ¥é¡¹ç›®æ§åˆ¶å™¨ä¿¡å·
        self.project_controller.projectsLoaded.connect(self.on_projects_loaded)
        self.project_controller.projectCreated.connect(self.on_project_created)
        self.project_controller.projectDetailsLoaded.connect(self.on_project_details_loaded)

        # è¿æ¥äº•æ§åˆ¶å™¨ä¿¡å·
        self.well_controller.wellListLoaded.connect(self.on_well_list_loaded)
        self.well_controller.wellCreated.connect(self.on_well_created)
        self.well_controller.wellUpdated.connect(self.on_well_updated)
        self.well_controller.wellDeleted.connect(self.on_well_deleted)

        # è¿æ¥é”™è¯¯ä¿¡å·å¤„ç†
        self.project_controller.error.connect(self.on_controller_error)
        self.well_controller.error.connect(self.on_controller_error)
        self.reservoir_controller.error.connect(self.on_controller_error)
        # ğŸ”¥ è¿æ¥å•ä½åˆ¶å˜åŒ–ä¿¡å·åˆ°å…¶ä»–æ§åˆ¶å™¨
        # self.unit_system_controller.unitSystemChanged.connect(self.on_unit_system_changed)

        # å°†æ§åˆ¶å™¨æ³¨å†Œåˆ°QMLå¼•æ“
        self.engine.rootContext().setContextProperty("loginController", self.login_controller)
        self.engine.rootContext().setContextProperty("projectController", self.project_controller)
        self.engine.rootContext().setContextProperty("wellController", self.well_controller)
        self.engine.rootContext().setContextProperty("reservoirController", self.reservoir_controller)
        # åœ¨æ³¨å†Œæ§åˆ¶å™¨åˆ°QMLå¼•æ“éƒ¨åˆ†æ·»åŠ ï¼š
        self.engine.rootContext().setContextProperty("wellStructureController", self.well_structure_controller)
        self.engine.rootContext().setContextProperty("excelImportController", self.excel_import_controller)

        self.engine.rootContext().setContextProperty("deviceController", self.device_controller)
        self.engine.rootContext().setContextProperty("deviceRecommendationController", self.device_recommendation_controller)
        self.engine.rootContext().setContextProperty("pumpCurvesController", self.pump_curves_controller)
        self.engine.rootContext().setContextProperty("continuousLearningController", self.continuous_learning_controller)

        self.engine.rootContext().setContextProperty("unitSystemController", self.unit_system_controller)
        self.engine.rootContext().setContextProperty("knowledgeGraphController", self.knowledge_graph_controller)

        # è¿æ¥Excelå¯¼å…¥æ§åˆ¶å™¨ä¿¡å·
        self.excel_import_controller.templateGenerated.connect(self.on_template_generated)
        self.excel_import_controller.templateGenerationFailed.connect(self.on_template_generation_failed)
        # ğŸ”¥ è¿æ¥è®¾å¤‡å¯¼å‡ºä¿¡å·
        self.device_controller.exportCompleted.connect(self.on_device_export_completed)
        self.device_controller.exportProgress.connect(self.on_device_export_progress)
        self.device_controller.exportFailed.connect(self.on_device_export_failed)

        # åŠ è½½ç™»å½•QMLæ–‡ä»¶
        qml_file = Path(__file__).resolve().parent / "QT_Oil_NewContent/StartWindow.qml"
        self.engine.load(QUrl.fromLocalFile(str(qml_file)))

        if not self.engine.rootObjects():
            print("Failed to load StartWindow.qml")
            sys.exit(-1)

    # åœ¨æ‚¨çš„main.pyä¸­æ·»åŠ å­—ä½“è®¾ç½®
    def setup_global_font(self):
        """è®¾ç½®å…¨å±€å­—ä½“ä¸ºå®‹ä½“"""
        try:
            # è®¾ç½®åº”ç”¨ç¨‹åºé»˜è®¤å­—ä½“
            font = QFont("SimSun", 10)
            if font.family() != "SimSun":
                # å¦‚æœå®‹ä½“ä¸å¯ç”¨ï¼Œå°è¯•å…¶ä»–ä¸­æ–‡å­—ä½“
                fallback_fonts = ["Microsoft YaHei", "å¾®è½¯é›…é»‘", "Arial Unicode MS"]
                for fallback in fallback_fonts:
                    test_font = QFont(fallback, 10)
                    if test_font.family() == fallback:
                        font = test_font
                        break
        
            self.app.setFont(font)
        
            # å°†å­—ä½“ä¿¡æ¯ä¼ é€’ç»™QML
            self.engine.rootContext().setContextProperty("globalFontFamily", font.family())
            self.engine.rootContext().setContextProperty("globalFontSize", 10)
        
            print(f"å…¨å±€å­—ä½“è®¾ç½®å®Œæˆ: {font.family()}")
        
        except Exception as e:
            print(f"è®¾ç½®å­—ä½“å¤±è´¥: {e}")

    def run(self):
        """è¿è¡Œåº”ç”¨ç¨‹åºä¸»å¾ªç¯"""
        return self.app.exec()

    @Slot(str, str)
    def on_login_success(self, project_name, user_name):
        """ç™»å½•æˆåŠŸå¤„ç†å‡½æ•°"""
        print(f"ç™»å½•æˆåŠŸ! é¡¹ç›®: {project_name}, ç”¨æˆ·: {user_name}")

        # ä¿å­˜ç”¨æˆ·ä¿¡æ¯
        self.current_user = user_name
        self.current_project = project_name

        # è·å–é¡¹ç›®è¯¦æƒ…
        project = self.project_controller.getProjectByName(project_name)
        if project and 'id' in project:
            self.current_project_id = project['id']

        # åˆ‡æ¢åˆ°ä¸»çª—å£
        self.open_main_window(project_name, user_name)

    @Slot(str)
    def on_login_failed(self, error_message):
        """ç™»å½•å¤±è´¥å¤„ç†å‡½æ•°"""
        print(f"ç™»å½•å¤±è´¥: {error_message}")
        # é”™è¯¯æç¤ºå·²åœ¨QMLä¸­å¤„ç†

    @Slot(list)
    def on_projects_loaded(self, projects):
        """é¡¹ç›®åˆ—è¡¨åŠ è½½å®Œæˆå¤„ç†å‡½æ•°"""
        print(f"é¡¹ç›®åˆ—è¡¨åŠ è½½å®Œæˆï¼Œå…± {len(projects)} ä¸ªé¡¹ç›®")

    @Slot(int, str)
    def on_project_created(self, project_id, project_name):
        """é¡¹ç›®åˆ›å»ºæˆåŠŸå¤„ç†å‡½æ•°"""
        print(f"é¡¹ç›®åˆ›å»ºæˆåŠŸ: {project_name} (ID: {project_id})")

    @Slot(dict)
    def on_project_details_loaded(self, project_details):
        """é¡¹ç›®è¯¦æƒ…åŠ è½½å®Œæˆå¤„ç†å‡½æ•°"""
        print(f"é¡¹ç›®è¯¦æƒ…åŠ è½½å®Œæˆ: {project_details.get('project_name', '')}")

        # å¦‚æœæ˜¯å½“å‰é¡¹ç›®ï¼ŒåŠ è½½ç›¸å…³æ•°æ®
        if project_details.get('id') == self.current_project_id:
            # åŠ è½½äº•æ•°æ®å’Œæ²¹è—æ•°æ®
            self.well_controller.getWellData(self.current_project_id)
            self.reservoir_controller.getReservoirData(self.current_project_id)

    @Slot(str)
    def on_controller_error(self, error_message):
        """æ§åˆ¶å™¨é”™è¯¯å¤„ç†å‡½æ•°"""
        print(f"æ§åˆ¶å™¨é”™è¯¯: {error_message}")
        # è¿™é‡Œå¯ä»¥æ·»åŠ å…¨å±€é”™è¯¯å¤„ç†é€»è¾‘

    def open_main_window(self, project_name, user_name):
        
        """æ‰“å¼€ä¸»çª—å£"""
        try:
            # å…ˆåŠ è½½ä¸»çª—å£
            main_qml = Path(__file__).resolve().parent / "QT_Oil_NewContent/MainWindow.qml"

            # ç¡®ä¿æ–‡ä»¶å­˜åœ¨
            if not main_qml.exists():
                print(f"MainWindow.qml not found at: {main_qml}")
                return

            # å…³é—­ç™»å½•çª—å£
            if self.engine.rootObjects():
                login_window = self.engine.rootObjects()[0]
                login_window.close()

            # æ¸…ç†å¼•æ“
            self.engine.clearComponentCache()

            # é‡æ–°æ³¨å†Œæ‰€æœ‰æ§åˆ¶å™¨ï¼Œç¡®ä¿ä¸»çª—å£èƒ½è®¿é—®
            self.engine.rootContext().setContextProperty("loginController", self.login_controller)
            self.engine.rootContext().setContextProperty("projectController", self.project_controller)
            self.engine.rootContext().setContextProperty("wellController", self.well_controller)
            self.engine.rootContext().setContextProperty("reservoirController", self.reservoir_controller)
            # åœ¨open_main_windowæ–¹æ³•ä¸­ï¼Œé‡æ–°æ³¨å†Œæ§åˆ¶å™¨éƒ¨åˆ†ä¹Ÿè¦æ·»åŠ ï¼š
            self.engine.rootContext().setContextProperty("wellStructureController", self.well_structure_controller)
            self.engine.rootContext().setContextProperty("excelImportController", self.excel_import_controller)
            self.engine.rootContext().setContextProperty("deviceController", self.device_controller)
            self.engine.rootContext().setContextProperty("deviceRecommendationController", self.device_recommendation_controller)
            self.engine.rootContext().setContextProperty("continuousLearningController", self.continuous_learning_controller)
            self.engine.rootContext().setContextProperty("knowledgeGraphController", self.knowledge_graph_controller)
            self.engine.rootContext().setContextProperty("pumpCurvesController", self.pump_curves_controller)  # ğŸ”¥ ä¿®å¤ï¼šæ·»åŠ ç¼ºå¤±çš„æ³¨å†Œ
            self.engine.rootContext().setContextProperty("unitSystemController", self.unit_system_controller)  # ğŸ”¥ ä¿®å¤ï¼šæ·»åŠ ç¼ºå¤±çš„æ³¨å†Œ
            # åŠ è½½ä¸»çª—å£
            self.engine.load(QUrl.fromLocalFile(str(main_qml)))

            # è®¾ç½®ä¸»çª—å£çš„ä¿¡æ¯  
            if self.engine.rootObjects():
                # æ‰¾åˆ°æ–°åŠ è½½çš„ä¸»çª—å£ï¼ˆæœ€åä¸€ä¸ªï¼‰
                main_window = self.engine.rootObjects()[-1]
                print(f"è®¾ç½®ä¸»çª—å£ currentProjectId: {self.current_project_id}")
                main_window.setProperty("currentProjectId", self.current_project_id)

                main_window.setProperty("currentUserName", user_name)
                main_window.setProperty("currentProjectName", project_name)
                
                main_window.setProperty("isChinese", self.login_controller.language)
                # åœ¨ open_main_window æ–¹æ³•ä¸­æ·»åŠ 
                main_window.setProperty("isMetric", self.unit_system_controller.isMetric)
                print(f"ä¸»çª—å£å·²åŠ è½½ï¼Œç”¨æˆ·: {user_name}, é¡¹ç›®: {project_name}, é¡¹ç›®ID: {self.current_project_id}, è¯­è¨€: {'ä¸­æ–‡' if self.login_controller.language else 'è‹±æ–‡'}")

                # åŠ è½½é¡¹ç›®æ•°æ®
                if self.current_project_id > 0:
                    # è·å–é¡¹ç›®è¯¦æƒ…
                    self.project_controller.getProjectSummary(self.current_project_id)
                    # åŠ è½½äº•æ•°æ®å’Œæ²¹è—æ•°æ®
                    self.well_controller.getWellData(self.current_project_id)
                    self.reservoir_controller.getReservoirData(self.current_project_id)
            else:
                print("Failed to load MainWindow.qml")
            # ç¡®ä¿è®¾å¤‡æ¨èæ§åˆ¶å™¨æœ‰é¡¹ç›®ID
            if self.current_project_id > 0:
                self.device_recommendation_controller.currentProjectId = self.current_project_id
    

        except Exception as e:
            print(f"æ‰“å¼€ä¸»çª—å£æ—¶å‡ºé”™: {e}")
            import traceback
            traceback.print_exc()

    @Slot(list)
    def on_well_list_loaded(self, wells):
        """äº•åˆ—è¡¨åŠ è½½å®Œæˆå¤„ç†å‡½æ•°"""
        print(f"äº•åˆ—è¡¨åŠ è½½å®Œæˆï¼Œå…± {len(wells)} å£äº•")

    @Slot(int, str)
    def on_well_created(self, well_id, well_name):
        """äº•åˆ›å»ºæˆåŠŸå¤„ç†å‡½æ•°"""
        print(f"äº•åˆ›å»ºæˆåŠŸ: {well_name} (ID: {well_id})")

    @Slot(int, str)
    def on_well_updated(self, well_id, well_name):
        """äº•æ›´æ–°æˆåŠŸå¤„ç†å‡½æ•°"""
        print(f"äº•æ›´æ–°æˆåŠŸ: {well_name} (ID: {well_id})")

    @Slot(int, str)
    def on_well_deleted(self, well_id, well_name):
        """äº•åˆ é™¤æˆåŠŸå¤„ç†å‡½æ•°"""
        print(f"äº•åˆ é™¤æˆåŠŸ: {well_name} (ID: {well_id})")

    @Slot(str)
    def on_template_generated(self, file_path):
        """æ¨¡æ¿ç”ŸæˆæˆåŠŸå¤„ç†"""
        print(f"æ¨¡æ¿ç”ŸæˆæˆåŠŸ: {file_path}")

    @Slot(str)  
    def on_template_generation_failed(self, error_msg):
        """æ¨¡æ¿ç”Ÿæˆå¤±è´¥å¤„ç†"""
        print(f"æ¨¡æ¿ç”Ÿæˆå¤±è´¥: {error_msg}")

    @Slot(str, int)
    def on_device_export_completed(self, file_path, count):
        """è®¾å¤‡å¯¼å‡ºå®Œæˆå¤„ç†"""
        print(f"è®¾å¤‡å¯¼å‡ºå®Œæˆ: {count}ä¸ªè®¾å¤‡å·²å¯¼å‡ºåˆ° {file_path}")

    @Slot(int, int)
    def on_device_export_progress(self, current, total):
        """è®¾å¤‡å¯¼å‡ºè¿›åº¦å¤„ç†"""
        print(f"å¯¼å‡ºè¿›åº¦: {current}/{total}")

    @Slot(str)
    def on_device_export_failed(self, error_msg):
        """è®¾å¤‡å¯¼å‡ºå¤±è´¥å¤„ç†"""
        print(f"è®¾å¤‡å¯¼å‡ºå¤±è´¥: {error_msg}")

if __name__ == "__main__":
    app = Application()
    sys.exit(app.run())
