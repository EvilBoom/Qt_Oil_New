import QtQuick
import QtQuick.Controls
import QtQuick.Layouts
import QtQuick.Controls.Material
import "../../Common/Utils/UnitUtils.js" as UnitUtils

Dialog {
    id: root

    property int wellId: -1
    property bool isChineseMode: true
    property bool isNewCasing: true
    property var editingCasing: null
    // üî• Ê∑ªÂä†Âçï‰ΩçÂà∂Â±ûÊÄß
    property bool isMetric: false

    signal saved()

    // üî• ÁõëÂê¨Âçï‰ΩçÂà∂ÂèòÂåñ
    onIsMetricChanged: {
        console.log("CasingEditDialogÂçï‰ΩçÂà∂ÂàáÊç¢‰∏∫:", isMetric ? "ÂÖ¨Âà∂" : "Ëã±Âà∂")
        updateFormUnits()
    }
    title: isNewCasing ?
        (isChineseMode ? "Ê∑ªÂä†Â•óÁÆ°" : "Add Casing") :
        (isChineseMode ? "ÁºñËæëÂ•óÁÆ°" : "Edit Casing")

    width: 600
    height: 550
    modal: true
    standardButtons: Dialog.NoButton

    // üî• ÂÜÖÈÉ®Êï∞ÊçÆÂ±ûÊÄß - ÂßãÁªà‰ª•Êï∞ÊçÆÂ∫ìÂéüÂßãÂçï‰ΩçÂ≠òÂÇ®
    property string casingType: ""
    property string casingSize: ""
    property real topDepthValue: 0      // ÂÜÖÈÉ®Â≠òÂÇ®(ft)
    property real bottomDepthValue: 0   // ÂÜÖÈÉ®Â≠òÂÇ®(ft)
    property real topTvdValue: 0        // ÂÜÖÈÉ®Â≠òÂÇ®(ft)
    property real bottomTvdValue: 0     // ÂÜÖÈÉ®Â≠òÂÇ®(ft)
    property real innerDiameterValue: 0 // ÂÜÖÈÉ®Â≠òÂÇ®(mm)
    property real outerDiameterValue: 0 // ÂÜÖÈÉ®Â≠òÂÇ®(mm)
    property real wallThicknessValue: 0 // ÂÜÖÈÉ®Â≠òÂÇ®(mm)
    property real roughnessValue: 0
    property string material: ""
    property string grade: ""
    property real weightValue: 0        // ÂÜÖÈÉ®Â≠òÂÇ®(kg/m)
    property string manufacturer: ""
    property string notes: ""

    contentItem: ScrollView {
        contentWidth: availableWidth
        clip: true

        ColumnLayout {
            width: parent.width
            spacing: 16

            // Âü∫Êú¨‰ø°ÊÅØ
            GroupBox {
                Layout.fillWidth: true
                Layout.margins: 10
                title: isChineseMode ? "Âü∫Êú¨‰ø°ÊÅØ" : "Basic Information"

                GridLayout {
                    anchors.fill: parent
                    columns: 2
                    rowSpacing: 12
                    columnSpacing: 20

                    Label {
                        text: isChineseMode ? "Â•óÁÆ°Á±ªÂûã *" : "Casing Type *"
                        Layout.alignment: Qt.AlignRight
                    }
                    ComboBox {
                        id: casingTypeCombo
                        Layout.fillWidth: true
                        model: isChineseMode ?
                            ["", "Ë°®Â±ÇÂ•óÁÆ°", "ÊäÄÊúØÂ•óÁÆ°", "Áîü‰∫ßÂ•óÁÆ°"] :
                            ["", "Surface Casing", "Intermediate Casing", "Production Casing"]

                        Component.onCompleted: updateCasingTypeIndex()

                        onCurrentTextChanged: {
                            if (currentIndex > 0) {
                                casingType = getCurrentCasingTypeValue()
                            }
                        }
                    }

                    Label {
                        text: isChineseMode ? "Â•óÁÆ°Â∞∫ÂØ∏" : "Casing Size"
                        Layout.alignment: Qt.AlignRight
                    }
                    TextField {
                        Layout.fillWidth: true
                        text: casingSize
                        placeholderText: isChineseMode ? "‰æãÂ¶Ç: 9-5/8\"" : "e.g., 9-5/8\""
                        onTextChanged: casingSize = text
                    }
                }
            }

            // Ê∑±Â∫¶‰ø°ÊÅØ
            GroupBox {
                Layout.fillWidth: true
                Layout.margins: 10
                title: isChineseMode ? "Ê∑±Â∫¶‰ø°ÊÅØ" : "Depth Information"

                GridLayout {
                    anchors.fill: parent
                    columns: 2
                    rowSpacing: 12
                    columnSpacing: 20

                    Label {
                        text: isChineseMode ?
                            `È°∂Ê∑± (${getDepthUnit()}) *` :
                            `Top Depth (${getDepthUnit()}) *`
                        Layout.alignment: Qt.AlignRight
                    }
                    TextField {
                        id: topDepthField
                        Layout.fillWidth: true
                        text: formatDepthForDisplay(topDepthValue)
                        placeholderText: "0.00"
                        validator: DoubleValidator { bottom: 0; decimals: 2 }
                        onTextChanged: {
                            topDepthValue = convertDepthToInternal(text)
                        }
                    }

                    Label {
                        text: isChineseMode ?
                            `Â∫ïÊ∑± (${getDepthUnit()}) *` :
                            `Bottom Depth (${getDepthUnit()}) *`
                        Layout.alignment: Qt.AlignRight
                    }
                    TextField {
                        id: bottomDepthField
                        Layout.fillWidth: true
                        text: formatDepthForDisplay(bottomDepthValue)
                        placeholderText: "0.00"
                        validator: DoubleValidator { bottom: 0; decimals: 2 }
                        onTextChanged: {
                            bottomDepthValue = convertDepthToInternal(text)
                        }
                    }

                    Label {
                        text: isChineseMode ?
                            `È°∂ÈÉ®ÂûÇÊ∑± (${getDepthUnit()})` :
                            `Top TVD (${getDepthUnit()})`
                        Layout.alignment: Qt.AlignRight
                    }
                    TextField {
                        id: topTvdField
                        Layout.fillWidth: true
                        text: formatDepthForDisplay(topTvdValue)
                        placeholderText: "0.00"
                        validator: DoubleValidator { bottom: 0; decimals: 2 }
                        onTextChanged: {
                            topTvdValue = convertDepthToInternal(text)
                        }
                    }

                    Label {
                        text: isChineseMode ?
                            `Â∫ïÈÉ®ÂûÇÊ∑± (${getDepthUnit()})` :
                            `Bottom TVD (${getDepthUnit()})`
                        Layout.alignment: Qt.AlignRight
                    }
                    TextField {
                        id: bottomTvdField
                        Layout.fillWidth: true
                        text: formatDepthForDisplay(bottomTvdValue)
                        placeholderText: "0.00"
                        validator: DoubleValidator { bottom: 0; decimals: 2 }
                        onTextChanged: {
                            bottomTvdValue = convertDepthToInternal(text)
                        }
                    }
                }
            }

            // Â∞∫ÂØ∏ÂèÇÊï∞
            GroupBox {
                Layout.fillWidth: true
                Layout.margins: 10
                title: isChineseMode ? "Â∞∫ÂØ∏ÂèÇÊï∞" : "Dimension Parameters"

                GridLayout {
                    anchors.fill: parent
                    columns: 2
                    rowSpacing: 12
                    columnSpacing: 20

                    Label {
                        text: isChineseMode ?
                            `ÂÜÖÂæÑ (${getDiameterUnit()}) *` :
                            `Inner Diameter (${getDiameterUnit()}) *`
                        Layout.alignment: Qt.AlignRight
                    }
                    TextField {
                        id: innerDiameterField
                        Layout.fillWidth: true
                        text: formatDiameterForDisplay(innerDiameterValue)
                        placeholderText: "0.00"
                        validator: DoubleValidator { bottom: 0; decimals: 2 }
                        onTextChanged: {
                            innerDiameterValue = convertDiameterToInternal(text)
                        }
                    }

                    Label {
                        text: isChineseMode ?
                            `Â§ñÂæÑ (${getDiameterUnit()}) *` :
                            `Outer Diameter (${getDiameterUnit()}) *`
                        Layout.alignment: Qt.AlignRight
                    }
                    TextField {
                        id: outerDiameterField
                        Layout.fillWidth: true
                        text: formatDiameterForDisplay(outerDiameterValue)
                        placeholderText: "0.00"
                        validator: DoubleValidator { bottom: 0; decimals: 2 }
                        onTextChanged: {
                            outerDiameterValue = convertDiameterToInternal(text)
                        }
                    }

                    Label {
                        text: isChineseMode ?
                            `Â£ÅÂéö (${getDiameterUnit()})` :
                            `Wall Thickness (${getDiameterUnit()})`
                        Layout.alignment: Qt.AlignRight
                    }
                    TextField {
                        id: wallThicknessField
                        Layout.fillWidth: true
                        text: formatDiameterForDisplay(wallThicknessValue)
                        placeholderText: "0.00"
                        validator: DoubleValidator { bottom: 0; decimals: 2 }
                        onTextChanged: {
                            wallThicknessValue = convertDiameterToInternal(text)
                        }
                    }

                    Label {
                        text: isChineseMode ? "Á≤óÁ≥ôÂ∫¶" : "Roughness"
                        Layout.alignment: Qt.AlignRight
                    }
                    TextField {
                        id: roughnessField
                        Layout.fillWidth: true
                        text: roughnessValue > 0 ? roughnessValue.toString() : ""
                        placeholderText: "0.0000"
                        validator: DoubleValidator { bottom: 0; decimals: 4 }
                        onTextChanged: {
                            roughnessValue = parseFloat(text) || 0
                        }
                    }
                }
            }

            // ÊùêË¥®‰ø°ÊÅØ
            GroupBox {
                Layout.fillWidth: true
                Layout.margins: 10
                title: isChineseMode ? "ÊùêË¥®‰ø°ÊÅØ" : "Material Information"

                GridLayout {
                    anchors.fill: parent
                    columns: 2
                    rowSpacing: 12
                    columnSpacing: 20

                    Label {
                        text: isChineseMode ? "ÊùêË¥®" : "Material"
                        Layout.alignment: Qt.AlignRight
                    }
                    TextField {
                        Layout.fillWidth: true
                        text: material
                        placeholderText: isChineseMode ? "‰æãÂ¶Ç: Á¢≥Èí¢" : "e.g., Carbon Steel"
                        onTextChanged: material = text
                    }

                    Label {
                        text: isChineseMode ? "Èí¢Á∫ß" : "Grade"
                        Layout.alignment: Qt.AlignRight
                    }
                    ComboBox {
                        id: gradeField
                        Layout.fillWidth: true
                        editable: true
                        model: ["J55", "K55", "N80", "L80", "P110", "Q125", "T95", "C90", "C95"]
                        editText: grade
                        onEditTextChanged: grade = editText
                        onCurrentTextChanged: if (currentIndex >= 0) grade = currentText
                    }

                    Label {
                        text: isChineseMode ?
                            `Âçï‰ΩçÈáçÈáè (${getWeightUnit()}/m)` :
                            `Weight (${getWeightUnit()}/ft)`
                        Layout.alignment: Qt.AlignRight
                    }
                    TextField {
                        id: weightField
                        Layout.fillWidth: true
                        text: formatWeightForDisplay(weightValue)
                        placeholderText: "0.00"
                        validator: DoubleValidator { bottom: 0; decimals: 2 }
                        onTextChanged: {
                            weightValue = convertWeightToInternal(text)
                        }
                    }

                    Label {
                        text: isChineseMode ? "Âà∂ÈÄ†ÂïÜ" : "Manufacturer"
                        Layout.alignment: Qt.AlignRight
                    }
                    TextField {
                        Layout.fillWidth: true
                        text: manufacturer
                        onTextChanged: manufacturer = text
                    }
                }
            }

            // Â§áÊ≥®
            GroupBox {
                Layout.fillWidth: true
                Layout.margins: 10
                Layout.preferredHeight: 100
                title: isChineseMode ? "Â§áÊ≥®" : "Notes"

                ScrollView {
                    anchors.fill: parent
                    TextArea {
                        text: notes
                        placeholderText: isChineseMode ? "ËØ∑ËæìÂÖ•Â§áÊ≥®‰ø°ÊÅØ..." : "Enter notes..."
                        wrapMode: TextArea.Wrap
                        onTextChanged: notes = text
                        selectByMouse: true
                    }
                }
            }

            Item {
                Layout.fillWidth: true
                Layout.preferredHeight: 10
            }
        }
    }

    footer: DialogButtonBox {
        Button {
            text: isChineseMode ? "‰øùÂ≠ò" : "Save"
            DialogButtonBox.buttonRole: DialogButtonBox.AcceptRole
            highlighted: true
            enabled: validateInput()

            onClicked: saveCasingData()
        }

        Button {
            text: isChineseMode ? "ÂèñÊ∂à" : "Cancel"
            DialogButtonBox.buttonRole: DialogButtonBox.RejectRole

            onClicked: root.reject()
        }
    }

    // üî• =====================================
    // üî• Âçï‰ΩçËΩ¨Êç¢ÂíåÊ†ºÂºèÂåñÂáΩÊï∞
    // üî• =====================================

    function getDepthUnit() {
        return isMetric ? "m" : "ft"
    }

    function getDiameterUnit() {
        return isMetric ? "mm" : "in"
    }

    function getWeightUnit() {
        return isMetric ? "kg" : "lbs"
    }

    // Ê∑±Â∫¶ËΩ¨Êç¢ÂáΩÊï∞ (Êï∞ÊçÆÂ∫ìÂ≠òÂÇ®‰∏∫ft)
    function formatDepthForDisplay(valueInFt) {
        if (!valueInFt || valueInFt <= 0) return ""

        if (isMetric) {
            return UnitUtils.feetToMeters(valueInFt).toFixed(1)
        } else {
            return valueInFt.toFixed(1)
        }
    }

    function convertDepthToInternal(displayText) {
        var value = parseFloat(displayText)
        if (isNaN(value)) return 0

        if (isMetric) {
            return UnitUtils.metersToFeet(value)  // ËΩ¨Êç¢‰∏∫Ëã±Â∞∫Â≠òÂÇ®
        } else {
            return value  // Áõ¥Êé•Â≠òÂÇ®Ëã±Â∞∫
        }
    }

    // Áõ¥ÂæÑËΩ¨Êç¢ÂáΩÊï∞ (Êï∞ÊçÆÂ∫ìÂ≠òÂÇ®‰∏∫mm)
    function formatDiameterForDisplay(valueInMm) {
        if (!valueInMm || valueInMm <= 0) return ""

        if (isMetric) {
            return valueInMm.toFixed(1)
        } else {
            return UnitUtils.mmToInches(valueInMm).toFixed(2)
        }
    }

    function convertDiameterToInternal(displayText) {
        var value = parseFloat(displayText)
        if (isNaN(value)) return 0

        if (isMetric) {
            return value  // Áõ¥Êé•Â≠òÂÇ®ÊØ´Á±≥
        } else {
            return UnitUtils.inchesToMm(value)  // ËΩ¨Êç¢‰∏∫ÊØ´Á±≥Â≠òÂÇ®
        }
    }

    // ÈáçÈáèËΩ¨Êç¢ÂáΩÊï∞ (Êï∞ÊçÆÂ∫ìÂ≠òÂÇ®‰∏∫kg/m)
    function formatWeightForDisplay(valueInKgPerM) {
        if (!valueInKgPerM || valueInKgPerM <= 0) return ""

        if (isMetric) {
            return valueInKgPerM.toFixed(2)
        } else {
            // ËΩ¨Êç¢‰∏∫ lbs/ft
            var lbsPerFt = valueInKgPerM * 2.20462 * 0.3048
            return lbsPerFt.toFixed(2)
        }
    }

    function convertWeightToInternal(displayText) {
        var value = parseFloat(displayText)
        if (isNaN(value)) return 0

        if (isMetric) {
            return value  // Áõ¥Êé•Â≠òÂÇ® kg/m
        } else {
            // ‰ªé lbs/ft ËΩ¨Êç¢‰∏∫ kg/m
            return value / 2.20462 / 0.3048
        }
    }

    // Â•óÁÆ°Á±ªÂûãÂ§ÑÁêÜ
    function getCurrentCasingTypeValue() {
        var currentText = casingTypeCombo.currentText
        if (isChineseMode) {
            switch(currentText) {
                case "Ë°®Â±ÇÂ•óÁÆ°": return "surface"
                case "ÊäÄÊúØÂ•óÁÆ°": return "intermediate"
                case "Áîü‰∫ßÂ•óÁÆ°": return "production"
                default: return ""
            }
        } else {
            switch(currentText) {
                case "Surface Casing": return "surface"
                case "Intermediate Casing": return "intermediate"
                case "Production Casing": return "production"
                default: return ""
            }
        }
    }

    function updateCasingTypeIndex() {
        var targetIndex = 0
        if (isChineseMode) {
            switch(casingType) {
                case "surface": targetIndex = 1; break
                case "intermediate": targetIndex = 2; break
                case "production": targetIndex = 3; break
                default: targetIndex = 0; break
            }
        } else {
            switch(casingType) {
                case "surface": targetIndex = 1; break
                case "intermediate": targetIndex = 2; break
                case "production": targetIndex = 3; break
                default: targetIndex = 0; break
            }
        }
        casingTypeCombo.currentIndex = targetIndex
    }

    function updateFormUnits() {
        console.log("Êõ¥Êñ∞Â•óÁÆ°ÁºñËæëË°®ÂçïÂçï‰ΩçÊòæÁ§∫")

        // Êõ¥Êñ∞ÊâÄÊúâÂ≠óÊÆµÁöÑÊòæÁ§∫ÂÄº
        topDepthField.text = formatDepthForDisplay(topDepthValue)
        bottomDepthField.text = formatDepthForDisplay(bottomDepthValue)
        topTvdField.text = formatDepthForDisplay(topTvdValue)
        bottomTvdField.text = formatDepthForDisplay(bottomTvdValue)

        innerDiameterField.text = formatDiameterForDisplay(innerDiameterValue)
        outerDiameterField.text = formatDiameterForDisplay(outerDiameterValue)
        wallThicknessField.text = formatDiameterForDisplay(wallThicknessValue)

        weightField.text = formatWeightForDisplay(weightValue)
    }

    // ÊâìÂºÄÂØπËØùÊ°Ü - Êñ∞Âª∫
    function openForNew() {
        isNewCasing = true
        editingCasing = null
        resetData()
        open()
    }

    // ÊâìÂºÄÂØπËØùÊ°Ü - ÁºñËæë
    function openForEdit(casing) {
        isNewCasing = false
        editingCasing = casing
        loadCasingData(casing)
        open()
    }

    // ÈáçÁΩÆÊï∞ÊçÆ
    function resetData() {
        casingType = ""
        casingSize = ""
        topDepthValue = ""
        bottomDepthValue = ""
        topTvdValue = ""
        bottomTvdValue = ""
        innerDiameterValue = ""
        outerDiameterValue = ""
        wallThicknessValue = ""
        roughnessValue = ""
        material = ""
        grade = ""
        weightValue = ""
        manufacturer = ""
        notes = ""

        // Êõ¥Êñ∞ÁïåÈù¢ÊòæÁ§∫
        updateFormUnits()
        updateCasingTypeIndex()
    }

    // üî• ‰øÆÊîπÂä†ËΩΩÂ•óÁÆ°Êï∞ÊçÆÂáΩÊï∞ÔºåÁ°Æ‰øùÊ≠£Á°ÆÁöÑÂçï‰ΩçËΩ¨Êç¢
    function loadCasingData(casing) {
        casingType = casing.casing_type || ""
        casingSize = casing.casing_size || ""

        // üî• Âä†ËΩΩÊ∑±Â∫¶Êï∞ÊçÆ (ÂÅáËÆæÊï∞ÊçÆÂ∫ìÂ≠òÂÇ®‰∏∫ft)
        topDepthValue = parseFloat(casing.top_depth) || 0
        bottomDepthValue = parseFloat(casing.bottom_depth) || 0
        topTvdValue = parseFloat(casing.top_tvd) || 0
        bottomTvdValue = parseFloat(casing.bottom_tvd) || 0

        // üî• Âä†ËΩΩÁõ¥ÂæÑÊï∞ÊçÆ (ÂÅáËÆæÊï∞ÊçÆÂ∫ìÂ≠òÂÇ®‰∏∫mm)
        innerDiameterValue = parseFloat(casing.inner_diameter) || 0
        outerDiameterValue = parseFloat(casing.outer_diameter) || 0
        wallThicknessValue = parseFloat(casing.wall_thickness) || 0

        roughnessValue = parseFloat(casing.roughness) || 0
        material = casing.material || ""
        grade = casing.grade || ""

        // üî• Âä†ËΩΩÈáçÈáèÊï∞ÊçÆ (ÂÅáËÆæÊï∞ÊçÆÂ∫ìÂ≠òÂÇ®‰∏∫kg/m)
        weightValue = parseFloat(casing.weight) || 0

        manufacturer = casing.manufacturer || ""
        notes = casing.notes || ""

        // Êõ¥Êñ∞ÁïåÈù¢ÊòæÁ§∫
        updateFormUnits()
        updateCasingTypeIndex()
    }

    // üî• ‰øÆÊîπÈ™åËØÅËæìÂÖ•ÂáΩÊï∞
    function validateInput() {
        return casingType.length > 0 &&
               topDepthValue > 0 &&
               bottomDepthValue > 0 &&
               innerDiameterValue > 0 &&
               outerDiameterValue > 0 &&
               topDepthValue < bottomDepthValue &&
               innerDiameterValue < outerDiameterValue
    }

    // üî• ‰øÆÊîπ‰øùÂ≠òÂ•óÁÆ°Êï∞ÊçÆÂáΩÊï∞ÔºåÁ°Æ‰øù‰ª•Ê≠£Á°ÆÂçï‰Ωç‰øùÂ≠ò
    function saveCasingData() {
        var dataToSave = {
            well_id: wellId,
            casing_type: casingType,
            casing_size: casingSize || null,
            // üî• Ê∑±Â∫¶Êï∞ÊçÆ‰ª•Ëã±Â∞∫‰øùÂ≠ò
            top_depth: topDepthValue,
            bottom_depth: bottomDepthValue,
            top_tvd: topTvdValue > 0 ? topTvdValue : null,
            bottom_tvd: bottomTvdValue > 0 ? bottomTvdValue : null,
            // üî• Áõ¥ÂæÑÊï∞ÊçÆ‰ª•ÊØ´Á±≥‰øùÂ≠ò
            inner_diameter: innerDiameterValue,
            outer_diameter: outerDiameterValue,
            wall_thickness: wallThicknessValue > 0 ? wallThicknessValue : null,
            roughness: roughnessValue > 0 ? roughnessValue : null,
            material: material || null,
            grade: grade || null,
            // üî• ÈáçÈáèÊï∞ÊçÆ‰ª•kg/m‰øùÂ≠ò
            weight: weightValue > 0 ? weightValue : null,
            manufacturer: manufacturer || null,
            notes: notes || null
        }

        console.log("‰øùÂ≠òÂ•óÁÆ°Êï∞ÊçÆ:", JSON.stringify(dataToSave, null, 2))

        if (!isNewCasing && editingCasing) {
            dataToSave.id = editingCasing.id
            wellStructureController.updateCasing(dataToSave)
        } else {
            wellStructureController.createCasing(dataToSave)
        }

        saved()
        accept()
    }

    // üî• Ê∑ªÂä†Ë∞ÉËØïÂáΩÊï∞
    function debugUnitConversion() {
        console.log("=== Â•óÁÆ°ÁºñËæëÂô®Âçï‰ΩçËΩ¨Êç¢Ë∞ÉËØï ===")
        console.log("ÂΩìÂâçÂçï‰ΩçÂà∂:", isMetric ? "ÂÖ¨Âà∂" : "Ëã±Âà∂")
        console.log("Ê∑±Â∫¶Âçï‰Ωç:", getDepthUnit())
        console.log("Áõ¥ÂæÑÂçï‰Ωç:", getDiameterUnit())
        console.log("ÈáçÈáèÂçï‰Ωç:", getWeightUnit())
        console.log("È°∂Ê∑± - ÂÜÖÈÉ®ÂÄº:", topDepthValue, "ft, ÊòæÁ§∫ÂÄº:", formatDepthForDisplay(topDepthValue))
        console.log("Â§ñÂæÑ - ÂÜÖÈÉ®ÂÄº:", outerDiameterValue, "mm, ÊòæÁ§∫ÂÄº:", formatDiameterForDisplay(outerDiameterValue))
        console.log("ÈáçÈáè - ÂÜÖÈÉ®ÂÄº:", weightValue, "kg/m, ÊòæÁ§∫ÂÄº:", formatWeightForDisplay(weightValue))
    }
}
