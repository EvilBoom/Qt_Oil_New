import QtQuick
import QtQuick.Controls
import QtQuick.Layouts
import QtQuick.Dialogs
import QtQuick.Controls.Material

Dialog {
    id: root

    property int wellId: -1
    property string wellName: ""
    property bool isChineseMode: true

    title: isChineseMode ? "ÂØºÂÖ•ExcelËΩ®ËøπÊï∞ÊçÆ" : "Import Excel Trajectory Data"
    width: 800
    height: 600
    modal: true

    // ËøûÊé•ÊéßÂà∂Âô®‰ø°Âè∑
    Connections {
        target: excelImportController

        function onFileLoaded(filePath) {
            fileNameLabel.text = filePath.split('/').pop()
            stepStack.currentIndex = 1
        }

        function onColumnsIdentified(columns) {
            updateColumnMapping(columns)
        }

        function onPreviewDataReady(data) {
            updatePreviewTable(data)
        }

        function onSheetsLoaded(sheets) {
            sheetComboBox.model = sheets
            if (sheets.length > 0) {
                sheetComboBox.currentIndex = 0
            }
        }

        function onValidationCompleted(summary) {
            updateValidationSummary(summary)
        }

        function onImportProgress(current, total) {
            importProgress.value = current / total
            importProgressText.text = `${current} / ${total}`
        }

        function onImportFailed(errorMsg) {
            errorDialog.errorMessage = errorMsg
            errorDialog.open()
        }
    }

    contentItem: StackLayout {
        id: stepStack
        currentIndex: 0

        // Ê≠•È™§1ÔºöÈÄâÊã©Êñá‰ª∂
        Item {
            ColumnLayout {
                anchors.fill: parent
                anchors.margins: 20
                spacing: 20

                Label {
                    text: isChineseMode ? "Ê≠•È™§ 1: ÈÄâÊã©ExcelÊñá‰ª∂" : "Step 1: Select Excel File"
                    font.pixelSize: 18
                    font.bold: true
                }

                Rectangle {
                    Layout.fillWidth: true
                    Layout.fillHeight: true
                    color: "#f5f7fa"
                    border.color: "#ddd"
                    border.width: 2
                    radius: 8

                    DropArea {
                        id: dropArea
                        anchors.fill: parent

                        onDropped: function(drop) {
                            if (drop.hasUrls && drop.urls.length > 0) {
                                var url = drop.urls[0]
                                excelImportController.loadExcelFile(url)
                            }
                        }
                    }

                    ColumnLayout {
                        anchors.centerIn: parent
                        spacing: 20

                        Text {
                            text: "üìÅ"
                            font.pixelSize: 64
                            color: "#999"
                            Layout.alignment: Qt.AlignHCenter
                        }

                        Text {
                            text: isChineseMode ?
                                "ÊãñÊãΩExcelÊñá‰ª∂Âà∞Ê≠§Â§Ñ\nÊàñ" :
                                "Drag Excel file here\nor"
                            horizontalAlignment: Text.AlignHCenter
                            color: "#666"
                            font.pixelSize: 16
                        }

                        Button {
                            text: isChineseMode ? "ÈÄâÊã©Êñá‰ª∂" : "Choose File"
                            Layout.alignment: Qt.AlignHCenter
                            highlighted: true

                            onClicked: fileDialog.open()
                        }

                        Label {
                            id: fileNameLabel
                            Layout.alignment: Qt.AlignHCenter
                            color: "#333"
                            font.pixelSize: 14
                        }
                    }
                }

                Label {
                    text: isChineseMode ?
                        "ÊîØÊåÅÊ†ºÂºèÔºö.xls, .xlsx\nÊñá‰ª∂Â∫îÂåÖÂê´TVD„ÄÅMDÂàóÔºåÂèØÈÄâDLSÂàó, Azim Grid
ÂíåInclÂàó" :
                        "Supported formats: .xls, .xlsx\nFile should contain TVD, MD columns, optional DLS, Azim Grid and Incl column"
                    color: "#666"
                    font.pixelSize: 12
                }
            }
        }

        // Ê≠•È™§2ÔºöÂàóÊò†Â∞ÑÂíåÈ¢ÑËßà
        Item {
            ColumnLayout {
                anchors.fill: parent
                anchors.margins: 20
                spacing: 20

                Label {
                    text: isChineseMode ? "Ê≠•È™§ 2: Á°ÆËÆ§Êï∞ÊçÆÊò†Â∞Ñ" : "Step 2: Confirm Data Mapping"
                    font.pixelSize: 18
                    font.bold: true
                }

                // Â∑•‰ΩúË°®ÈÄâÊã©
                RowLayout {
                    Layout.fillWidth: true

                    Label {
                        text: isChineseMode ? "Â∑•‰ΩúË°®:" : "Sheet:"
                    }

                    ComboBox {
                        id: sheetComboBox
                        Layout.preferredWidth: 200

                        onCurrentTextChanged: {
                            if (currentText) {
                                excelImportController.loadSheet(currentText)
                            }
                        }
                    }

                    Item { Layout.fillWidth: true }
                }

                // ÂàóÊò†Â∞ÑÊòæÁ§∫
                GroupBox {
                    Layout.fillWidth: true
                    title: isChineseMode ? "ÂàóÊò†Â∞Ñ" : "Column Mapping"

                    GridLayout {
                        anchors.fill: parent
                        columns: 2
                        rowSpacing: 10
                        columnSpacing: 20

                        Label {
                            text: "TVD ‚Üí "
                            font.bold: true
                        }
                        Label {
                            id: tvdColumnLabel
                            text: "-"
                            color: "#4a90e2"
                        }

                        Label {
                            text: "MD ‚Üí "
                            font.bold: true
                        }
                        Label {
                            id: mdColumnLabel
                            text: "-"
                            color: "#4a90e2"
                        }

                        Label {
                            text: "DLS ‚Üí "
                            font.bold: true
                        }
                        Label {
                            id: dlsColumnLabel
                            text: "-"
                            color: "#4a90e2"
                        }

                        // Êñ∞Â¢ûÔºö‰∫ïÊñúËßí
                        Label {
                            text: isChineseMode ? "‰∫ïÊñúËßí ‚Üí " : "Inclination ‚Üí "
                            font.bold: true
                        }
                        Label {
                            id: inclinationColumnLabel
                            text: "-"
                            color: "#4a90e2"
                        }

                        // Êñ∞Â¢ûÔºöÊñπ‰ΩçËßí
                        Label {
                            text: isChineseMode ? "Êñπ‰ΩçËßí ‚Üí " : "Azimuth ‚Üí "
                            font.bold: true
                        }
                        Label {
                            id: azimuthColumnLabel
                            text: "-"
                            color: "#4a90e2"
                        }
                    }
                }

                // Êï∞ÊçÆÈ¢ÑËßà
                GroupBox {
                    Layout.fillWidth: true
                    Layout.fillHeight: true
                    title: isChineseMode ? "Êï∞ÊçÆÈ¢ÑËßà" : "Data Preview"

                    ScrollView {
                        anchors.fill: parent

                        TableView {
                            id: previewTable
                            model: ListModel { id: previewModel }

                            delegate: Rectangle {
                                implicitWidth: 100
                                implicitHeight: 30
                                border.color: "#ddd"

                                Text {
                                    anchors.centerIn: parent
                                    text: modelData || ""
                                    elide: Text.ElideRight
                                }
                            }
                        }
                    }
                }

                // ÊåâÈíÆ
                RowLayout {
                    Layout.fillWidth: true

                    Button {
                        text: isChineseMode ? "‰∏ä‰∏ÄÊ≠•" : "Previous"
                        onClicked: stepStack.currentIndex = 0
                    }

                    Item { Layout.fillWidth: true }

                    Button {
                        text: isChineseMode ? "‰∏ã‰∏ÄÊ≠•" : "Next"
                        highlighted: true
                        enabled: tvdColumnLabel.text !== "-" && mdColumnLabel.text !== "-"
                        onClicked: {
                            excelImportController.validateData()
                            stepStack.currentIndex = 2
                        }
                    }
                }
            }
        }

        // Ê≠•È™§3ÔºöÈ™åËØÅÂíåÂØºÂÖ•
        Item {
            ColumnLayout {
                anchors.fill: parent
                anchors.margins: 20
                spacing: 20

                Label {
                    text: isChineseMode ? "Ê≠•È™§ 3: È™åËØÅÂíåÂØºÂÖ•" : "Step 3: Validate and Import"
                    font.pixelSize: 18
                    font.bold: true
                }

                // È™åËØÅÊëòË¶Å
                GroupBox {
                    Layout.fillWidth: true
                    title: isChineseMode ? "Êï∞ÊçÆÈ™åËØÅÊëòË¶Å" : "Data Validation Summary"

                    ColumnLayout {
                        anchors.fill: parent
                        spacing: 10

                        RowLayout {
                            Label {
                                text: isChineseMode ? "ÁõÆÊ†á‰∫ï:" : "Target Well:"
                                font.bold: true
                            }
                            Label {
                                text: wellName
                                color: "#4a90e2"
                            }
                        }

                        RowLayout {
                            Label {
                                id: dataCountLabel
                                text: isChineseMode ? "Êï∞ÊçÆË°åÊï∞: 0" : "Data Rows: 0"
                            }
                        }

                        RowLayout {
                            Label {
                                id: depthRangeLabel
                                text: isChineseMode ? "Ê∑±Â∫¶ËåÉÂõ¥: -" : "Depth Range: -"
                            }
                        }

                        // Ë≠¶Âëä‰ø°ÊÅØ
                        ScrollView {
                            Layout.fillWidth: true
                            Layout.preferredHeight: 100
                            visible: warningListModel.count > 0

                            ListView {
                                model: ListModel { id: warningListModel }
                                delegate: Text {
                                    text: "‚ö†Ô∏è " + modelData
                                    color: "#ff9800"
                                    wrapMode: Text.Wrap
                                    width: parent.width
                                }
                            }
                        }
                    }
                }

                // ÂØºÂÖ•ËøõÂ∫¶
                GroupBox {
                    Layout.fillWidth: true
                    title: isChineseMode ? "ÂØºÂÖ•ËøõÂ∫¶" : "Import Progress"
                    visible: importProgress.value > 0

                    ColumnLayout {
                        anchors.fill: parent

                        ProgressBar {
                            id: importProgress
                            Layout.fillWidth: true
                            from: 0
                            to: 1
                            value: 0
                        }

                        Text {
                            id: importProgressText
                            Layout.alignment: Qt.AlignHCenter
                            text: "0 / 0"
                        }
                    }
                }

                Item { Layout.fillHeight: true }

                // ÊåâÈíÆ
                RowLayout {
                    Layout.fillWidth: true

                    Button {
                        text: isChineseMode ? "‰∏ä‰∏ÄÊ≠•" : "Previous"
                        onClicked: stepStack.currentIndex = 1
                    }

                    Item { Layout.fillWidth: true }

                    Button {
                        text: isChineseMode ? "ÂºÄÂßãÂØºÂÖ•" : "Start Import"
                        highlighted: true
                        enabled: !importProgress.visible || importProgress.value >= 1

                        onClicked: {
                            importProgress.value = 0
                            excelImportController.importToWell(wellId)
                        }
                    }
                }
            }
        }
    }

    footer: DialogButtonBox {
        Button {
            text: isChineseMode ? "ÂÖ≥Èó≠" : "Close"
            DialogButtonBox.buttonRole: DialogButtonBox.RejectRole
        }
    }

    // Êñá‰ª∂ÈÄâÊã©ÂØπËØùÊ°Ü
    FileDialog {
        id: fileDialog
        title: isChineseMode ? "ÈÄâÊã©ExcelÊñá‰ª∂" : "Select Excel File"
        nameFilters: ["Excel files (*.xlsx *.xls)", "All files (*)"]

        onAccepted: {
            excelImportController.loadExcelFile(selectedFile)
        }
    }

    // ÈîôËØØÂØπËØùÊ°Ü
    Dialog {
        id: errorDialog
        title: isChineseMode ? "ÈîôËØØ" : "Error"
        modal: true
        standardButtons: Dialog.Ok

        property string errorMessage: ""

        contentItem: Text {
            text: errorDialog.errorMessage
            wrapMode: Text.Wrap
            color: "#f44336"
        }
    }

    // ËæÖÂä©ÂáΩÊï∞
    // ‰øÆÊîπupdateColumnMappingÂáΩÊï∞
    function updateColumnMapping(mapping) {
        tvdColumnLabel.text = mapping.TVD || "-"
        mdColumnLabel.text = mapping.MD || "-"
        dlsColumnLabel.text = mapping.DLS || "-"
        inclinationColumnLabel.text = mapping.INCLINATION || "-"  // Êñ∞Â¢û
        azimuthColumnLabel.text = mapping.AZIMUTH || "-"          // Êñ∞Â¢û
    }

    function updatePreviewTable(data) {
        previewModel.clear()
        // TODO: ÂÆûÁé∞Ë°®Ê†ºÈ¢ÑËßàÊï∞ÊçÆÊõ¥Êñ∞
    }

    function updateValidationSummary(summary) {
        dataCountLabel.text = isChineseMode ?
            `Êï∞ÊçÆË°åÊï∞: ${summary.data_count || 0}` :
            `Data Rows: ${summary.data_count || 0}`

        if (summary.statistics) {
            var stats = summary.statistics
            depthRangeLabel.text = isChineseMode ?
                `Ê∑±Â∫¶ËåÉÂõ¥: ${stats.min_tvd}m - ${stats.max_tvd}m` :
                `Depth Range: ${stats.min_tvd}m - ${stats.max_tvd}m`
        }

        // Êõ¥Êñ∞Ë≠¶ÂëäÂàóË°®
        warningListModel.clear()
        if (summary.warnings) {
            for (var i = 0; i < summary.warnings.length && i < 5; i++) {
                warningListModel.append({modelData: summary.warnings[i]})
            }
        }
    }

    onOpened: {
        // ÈáçÁΩÆÁä∂ÊÄÅ
        stepStack.currentIndex = 0
        importProgress.value = 0
        excelImportController.clearData()
    }
}
